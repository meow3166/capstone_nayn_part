{% include "include/header.html" %}
<main>
    <div class="aa">
        <div class="cal">
            <div class="card calendar-card">
                <h2 class="section-title">경기 일정</h2>

                <div class="calendar" id="table">
                    <div class="header">
                        <div class="month" id="month-header"></div>
                        <div class="buttons">
                            <button id="prev-btn" class="icon" title="이전 달">이전 달</button>
                            <button id="next-btn" class="icon" title="다음 달">다음 달</button>
                        </div>
                    </div>
                </div>
                <div id="tooltip"
                    style="display:none; position:absolute; background-color:#333; color:white; padding:5px 10px; border-radius:5px; font-size:14px; pointer-events:none;">
                </div>
            </div>
        </div>
        <div class="result_schedule">

            <div class="result-header">
                <span class="game-date" id="date"></span>
                <span class="game-status-chip" id="dynamic-status-chip"></span>
            </div>
            <!-- 경기 종료 -->
            <div class="game-result-card" id="card-game-finished">
                <div class="match-details">
                    <div class="match-header">
                        <strong>경기 결과</strong>
                    </div>
                    <div class="teams-container">
                        <div class="team-info">
                            <img id="finished-away-logo" class="team-logo_1" src="" alt="">
                            <p id="finished-away-score" class="final-score"></p>
                            <div id="finished-away-pitcher-container" class="pitcher-results"></div>
                        </div>
                        <span id="finished-vs-text" class="vs-text">VS</span>
                        <div class="team-info">
                            <img id="finished-home-logo" class="team-logo_1" src="" alt="">
                            <p id="finished-home-score" class="final-score"></p>
                            <div id="finished-home-pitcher-container" class="pitcher-results"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="game-result-card" id="card-no-game">
                <div class="match-details">
                    <div class="match-header">
                        <strong>경기 결과</strong>
                    </div>
                    <div class="teams-container">
                        <div> 등록된 경기 정보가 없습니다</div>
                    </div>
                </div>
            </div>
            <!-- 경기 예정 -->
            <div class="game-result-card" id="card-game-scheduled">
                <div class="match-details">
                    <div class="match-meta">
                        <span class="stadium" id="scheduled-stadium"></span>
                        <span class="time" id="scheduled-time"></span>
                    </div>

                    <div class="teams-container">
                        <div class="team-info">
                            <img id="scheduled-away-logo" class="team-logo_1" src="" alt="">
                            <p class="team-record" id="scheduled-away-record"></p>
                            <p class="pitcher-info" id="scheduled-away-pitcher-info"></p>
                        </div>
                        <span class="vs-text">VS</span>
                        <div class="team-info">
                            <img id="scheduled-home-logo" class="team-logo_1" src="" alt="">
                            <p class="team-record" id="scheduled-home-record"></p>
                            <p class="pitcher-info" id="scheduled-home-pitcher-info"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<footer></footer>
<script src="../assets/js/menubar.js"></script>

<script>
    // ===================================================================
    // 1. DOM 요소 변수 선언 (ID 기반으로 통일하여 오류 방지)
    // ===================================================================
    const cardFinished = document.getElementById('card-game-finished');
    const cardScheduled = document.getElementById('card-game-scheduled');
    const cardNoGame = document.getElementById('card-no-game');
    const statusChip = document.getElementById('dynamic-status-chip');
    const dateHeader = document.getElementById('date');

    // 경기 예정 카드 변수
    const scheduledStadium = document.getElementById('scheduled-stadium');
    const scheduledTime = document.getElementById('scheduled-time');
    const scheduledAwayLogo = document.getElementById('scheduled-away-logo');
    const scheduledAwayRecord = document.getElementById('scheduled-away-record');
    const scheduledAwayPitcherInfo = document.getElementById('scheduled-away-pitcher-info');
    const scheduledHomeLogo = document.getElementById('scheduled-home-logo');
    const scheduledHomeRecord = document.getElementById('scheduled-home-record');
    const scheduledHomePitcherInfo = document.getElementById('scheduled-home-pitcher-info');
    const scheduledVsText = cardScheduled.querySelector('.vs-text'); // VS 텍스트는 하나이므로 querySelector 사용

    // 경기 종료 카드 변수
    const finishedAwayLogo = document.getElementById('finished-away-logo');
    const finishedAwayScore = document.getElementById('finished-away-score');
    const finishedAwayPitcherContainer = document.getElementById('finished-away-pitcher-container');
    const finishedHomeLogo = document.getElementById('finished-home-logo');
    const finishedHomeScore = document.getElementById('finished-home-score');
    const finishedHomePitcherContainer = document.getElementById('finished-home-pitcher-container');
    const finishedVsText = document.getElementById('finished-vs-text');


    // ===================================================================
    // 2. Time Zone Safe 날짜 포맷팅 함수
    // ===================================================================
    function getLocalISOString(dateObj) {
        const year = dateObj.getFullYear();
        const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        const day = dateObj.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // ===================================================================
    // 3. API 호출 및 데이터 바인딩 함수
    // ===================================================================
    async function loadGameResult(dateObj) {
        let dateString = typeof dateObj === 'string' ? dateObj : getLocalISOString(dateObj);
        let displayDate = new Date(dateString).toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'short' });

        // 초기화
        dateHeader.textContent = displayDate;
        cardFinished.style.display = 'none';
        cardScheduled.style.display = 'none';
        cardNoGame.style.display = 'none';
        statusChip.textContent = '';
        statusChip.className = 'game-status-chip';

        try {
            const response = await fetch(`/api/game-by-date?date=${encodeURIComponent(dateString)}`);

            if (!response.ok) {
                // DB에 데이터가 없어서 404가 반환된 경우 -> 경기 정보 없음
                if (response.status === 404) {
                    cardNoGame.style.display = 'block';
                    statusChip.textContent = '경기 정보 없음';
                    statusChip.classList.add('no-game');
                }
                return;
            }
            const data = await response.json(); // 응답 데이터 전체를 일단 'data' 변수에 저장
            console.log("--- API 응답 데이터 전체 ---");
            console.log(data); // 데이터 구조 확인 (e.g., { game: {...} } 형태인지)
            console.log("----------------------------");

            const { game } = data; // 'data'에서 'game' 객체를 비구조화
            // --- ★ 데이터가 존재하면 무조건 경기 종료로 간주 (200 OK) ★ ---
            // const { game } = await response.json();

            statusChip.textContent = '경기 종료';
            statusChip.classList.add('finished');
            cardFinished.style.display = 'block';

            // 로고 바인딩
            finishedAwayLogo.src = game.away_team_logo;
            finishedAwayLogo.alt = game.away_team_name;
            finishedHomeLogo.src = game.home_team_logo;
            finishedHomeLogo.alt = game.home_team_name;

            // 스코어 및 승패 클래스 결정 (결과 필드가 없거나 null이면 무승부 클래스 적용)
            let awayScoreClass = 'draw';
            let homeScoreClass = 'draw';

            if (game.score_away > game.score_home) {
                awayScoreClass = 'winning'; homeScoreClass = 'losing';
            } else if (game.score_away < game.score_home) {
                awayScoreClass = 'losing'; homeScoreClass = 'winning';
            }
            if (game.game_status === 1) { // 1 = 종료
                statusChip.textContent = '경기 종료';
                statusChip.classList.add('finished');
                cardFinished.style.display = 'block';
            } else if (game.game_status === 0) { // 0 = 예정
                statusChip.textContent = '경기 예정';
                statusChip.classList.add('scheduled');
                cardScheduled.style.display = 'block';
                return; // ✅ 예정 경기니까 여기서 끝
            } else {
                cardNoGame.style.display = 'block';
                statusChip.textContent = '경기 정보 없음';
                statusChip.classList.add('no-game');
                return;
            }
            // 스코어 바인딩 및 클래스 적용
            finishedAwayScore.innerHTML = `${game.away_team_name_in_list}<br>${game.score_away}`;
            finishedAwayScore.className = `final-score ${awayScoreClass}`;
            finishedHomeScore.innerHTML = `${game.home_team_name_in_list}<br>${game.score_home}`;
            finishedHomeScore.className = `final-score ${homeScoreClass}`;
            finishedVsText.textContent = 'VS';
            cardFinished.style.cursor = 'pointer';

            cardFinished.onclick = async function () {
    const date = game.game_date.slice(0,10); // YYYY-MM-DD

    try {
        const res = await fetch(`/api/game-id-by-date?date=${encodeURIComponent(dateString)}`);
        if (!res.ok) throw new Error('API 응답 실패');

        const data = await res.json();

        if (data.ok && data.gameId) {
            // page_id 대신 gameId 사용
            cardFinished.style.cursor = 'pointer';
            cardFinished.onclick = () => {
                window.location.href = `/gameinfo_result?id=${data.gameId}`;
            };
        } else {
            alert('상세 경기 정보가 없습니다.');
        }
    } catch (err) {
        console.error(err);
        alert("경기 정보를 가져오는 중 오류가 발생했습니다.");
    }
};
            // finishedHomePitcherContainer.innerHTML = '';

            // 투수 정보 바인딩: 실제 DB 데이터(game.win_pitcher, game.lose_pitcher, game.save_pitcher) 사용
            finishedAwayPitcherContainer.innerHTML = ''; // 초기화
            finishedHomePitcherContainer.innerHTML = ''; // 초기화

            // 경기 결과(result) 필드가 없거나 null일 경우 투수 정보는 표시하지 않음
            // 경기가 실제로 종료되었고 (result 필드가 null이 아님), 투수 정보가 있는 경우에만 처리
            if (game.result && (game.win_pitcher || game.lose_pitcher || game.save_pitcher)) {

                // --- 1. 승리팀 결정 및 바인딩 ---
                let winningContainer = (awayScoreClass === 'winning') ? finishedAwayPitcherContainer : finishedHomePitcherContainer;

                // 승리 투수 (항상 존재해야 함)
                if (game.win_pitcher) {
                    winningContainer.innerHTML += `<p><span class="result-label win">승</span> ${game.win_pitcher}</p>`;
                }

                // 세이브 투수 (있을 수도, 없을 수도 있음)
                if (game.save_pitcher && game.save_pitcher !== 'null') { // MySQL에서 NULL이 문자열 'null'로 올 수 있기에 방어 코드 추가
                    winningContainer.innerHTML += `<p><span class="result-label save">세</span> ${game.save_pitcher}</p>`;
                }

                // --- 2. 패배팀 결정 및 바인딩 ---
                let losingContainer = (awayScoreClass === 'losing') ? finishedAwayPitcherContainer : finishedHomePitcherContainer;

                // 패전 투수 (Summary에서 추출한 값이 들어오므로, null이 아닌지 확인)
                if (game.lose_pitcher && game.lose_pitcher !== 'null') {
                    losingContainer.innerHTML += `<p><span class="result-label loss">패</span> ${game.lose_pitcher}</p>`;
                }
            }

        } catch (error) {
            console.error('경기 정보 로드 오류:', error);
            cardNoGame.style.display = 'block';
            statusChip.textContent = '오류 발생';
            statusChip.classList.add('error');
        }

    }
    document.addEventListener('DOMContentLoaded', function () {
        const today = new Date();
        // 1. 오늘 날짜의 경기 결과를 로드합니다.
        loadGameResult(today);

        // 2. 캘린더/달력 UI의 초기 날짜도 오늘로 설정하는 로직이 있다면 여기에 추가
    });
</script>
<script src="../assets/js/schedule.js"></script>

{%include "include/footer.html"%}